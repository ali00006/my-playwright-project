name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      test_file:
        description: "Test file path (e.g., tests/Assignment.spec.ts or Assignment.spec.ts). Leave empty to run default."
        required: false
        default: ""
      test_type:
        description: "Type of test to run (e.g., smoke, regression, api, e2e)"
        required: true
        type: string
        default: "smoke"
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: lts/*

      # Cache npm and Playwright browser binaries
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: |
          echo "Checking for existing browser installs..."
          ls -la ~/.cache/ms-playwright/ || echo "No cached browsers found"
          echo "Installing browsers (will skip if cached)..."
          npx playwright install --with-deps
          echo "Final browser cache state:"
          du -sh ~/.cache/ms-playwright/
      - name: Run Playwright tests
        run: |
          TEST_FILE="${{ github.event.inputs.test_file }}"
          TEST_TYPE="${{ github.event.inputs.test_type }}"

          echo "Test Type Selected: $TEST_TYPE"

          if [ -z "$TEST_FILE" ]; then
            echo "No test file provided; looking for tests in $TEST_TYPE directory"
            if [ -d "tests/$TEST_TYPE" ]; then
              TEST_PATH="tests/$TEST_TYPE"
            else
              echo "Warning: $TEST_TYPE directory not found, using default: Assignment.spec.ts"
              TEST_PATH="Assignment.spec.ts"
            fi
          else
            TEST_PATH="$TEST_FILE"
            echo "Using specified test file: $TEST_PATH"
          fi

          echo "Executing Playwright tests..."
          npx playwright test "$TEST_PATH" --workers=10
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
